version: '3.8'

services:
  quantum-db:
    image: postgres:15-alpine
    container_name: quantum-supabase-db-simple
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: VIGOLEONROCKS_QUANTUM_DB
      POSTGRES_HOST_AUTH_METHOD: trust
    volumes:
      - quantum-db-data-simple:/var/lib/postgresql/data
      - ./supabase_quantum_schema.sql:/docker-entrypoint-initdb.d/01-quantum-schema.sql:ro
    networks:
      - quantum-network-simple
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 20s
      timeout: 10s
      retries: 10

  quantum-redis:
    image: redis:7-alpine
    container_name: quantum-redis-simple
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - quantum-redis-data-simple:/data
    networks:
      - quantum-network-simple
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  quantum-kong:
    image: kong:2.8-alpine
    container_name: quantum-supabase-kong-simple
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /var/lib/kong/kong.yml
      KONG_DNS_ORDER: LAST,A,CNAME
      KONG_PLUGINS: request-transformer,cors
    volumes:
      - ./kong.simple.yml:/var/lib/kong/kong.yml:ro
    networks:
      - quantum-network-simple
    depends_on:
      - quantum-core

  quantum-core:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: quantum-consciousness-core-simple
    restart: unless-stopped
    environment:
      - SUPABASE_URL=http://quantum-kong:8000
      - SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhydnhzYW9sYXhucWx0b21xYXVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExNDU4MDEsImV4cCI6MjA2NjcyMTgwMX0.PdeDNbEX5c9VCYgWR35nV_Y8JYQXtkmYRXAA4rs68j0
      - SUPABASE_DB_HOST=quantum-db
      - SUPABASE_DB_PASSWORD=VIGOLEONROCKS_QUANTUM_DB
      - QUANTUM_CACHE_HOST=quantum-redis
      - LOG_LEVEL=INFO
      - BRAVE_API_KEY=${BRAVE_API_KEY}
    depends_on:
      quantum-db:
        condition: service_healthy
      quantum-redis:
        condition: service_healthy
    networks:
      - quantum-network-simple
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  quantum-db-data-simple:
    driver: local
  quantum-redis-data-simple:
    driver: local

networks:
  quantum-network-simple:
    driver: bridge
