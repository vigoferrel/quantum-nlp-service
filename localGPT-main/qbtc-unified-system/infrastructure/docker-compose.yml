# ==============================================================================
# || QBTC UNIFIED SYSTEM - INFRASTRUCTURE DOCKER COMPOSE                      ||
# ==============================================================================
#
# Este archivo define la infraestructura base para el sistema cuántico unificado.
# Incluye RabbitMQ para mensajería, Supabase/Postgres para persistencia,
# Redis para caching, y APISIX como API Gateway.
#
# Para iniciar la infraestructura:
#   docker-compose -f infrastructure/docker-compose.yml up -d
#

services:
  # ------------------------------------------------------------------------------
  # -- SERVICIOS DE MENSAJERÍA
  # ------------------------------------------------------------------------------
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: qbtc-rabbitmq
    hostname: qbtc-rabbit
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      # RABBITMQ_DEFAULT_VHOST: quantum_vhost # Definido en definitions.json para evitar conflictos
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "-rabbit load_definitions '/etc/rabbitmq/definitions.json'"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq/mnesia/
      # - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./rabbitmq-definitions.json:/etc/rabbitmq/definitions.json:ro
    networks:
      - qbtc_network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ------------------------------------------------------------------------------
  # -- SERVICIOS DE DATOS Y CACHÉ
  # ------------------------------------------------------------------------------
  supabase-db:
    image: supabase/postgres:15.1.0.117
    container_name: qbtc-supabase-db
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: VIGOLEONROCKS_QUANTUM_DB
      POSTGRES_DB: qbtc_unified_db
    volumes:
      - supabase_data:/var/lib/postgresql/data
      - ./db_schema:/docker-entrypoint-initdb.d # Scripts SQL para inicializar
    networks:
      - qbtc_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d qbtc_unified_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7.2-alpine
    container_name: qbtc-redis
    ports:
      - "6379:6379"
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru --save 60 1
    volumes:
      - redis_data:/data
    networks:
      - qbtc_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------------------------------------------------------------------------------
  # -- API GATEWAY
  # ------------------------------------------------------------------------------
  apisix:
    image: apache/apisix:3.7.0-debian
    container_name: qbtc-apisix
    restart: always
    environment:
      - APISIX_STAND_ALONE=true
    ports:
      - "9080:9080" # HTTP
      - "9443:9443" # HTTPS
      - "9180:9180" # Admin API
    volumes:
      - ./apisix_conf/config-default.yaml:/usr/local/apisix/conf/config-default.yaml:ro
      - ./apisix_conf/apisix.yaml:/usr/local/apisix/conf/apisix.yaml:ro
    depends_on:
      - rabbitmq
      - supabase-db
      - redis
    networks:
      - qbtc_network
    healthcheck:
        test: ["CMD-SHELL", "curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:9080/apisix/healthz | grep 200"]
        interval: 5s
        timeout: 3s
        retries: 5

  # ------------------------------------------------------------------------------
  # -- QBTC APPLICATION SERVICES
  # ------------------------------------------------------------------------------
  quantum-core-service:
    build:
      context: ../services/quantum-core-service
      dockerfile: Dockerfile
    container_name: qbtc-quantum-core
    restart: always
    environment:
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - qbtc_network

  llm-api-service:
    build:
      context: ../services/llm-api-service
      dockerfile: Dockerfile
    container_name: qbtc-llm-api
    restart: always
    ports:
      - "8000:8000"
    environment:
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - qbtc_network

  trading-hft-service:
    build:
      context: ../services/trading-hft-service
      dockerfile: Dockerfile
    container_name: qbtc-trading-hft
    restart: always
    environment:
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - qbtc_network

# ==============================================================================
# || VOLÚMENES Y REDES
# ==============================================================================
volumes:
  rabbitmq_data:
    driver: local
  supabase_data:
    driver: local
  redis_data:
    driver: local

networks:
  qbtc_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
