version: '3.8'

services:
  rabbitmq:
    image: "rabbitmq:3.12-management"
    hostname: "rabbitmq"
    ports:
      - "5672:5672"  # Puerto estándar de AMQP
      - "15672:15672" # Interfaz de gestión web
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq/
    networks:
      - qbtc_network

  api_server:
    build:
      context: ./services/api_server
    ports:
      - "5001:5001"
    depends_on:
      - rabbitmq
    networks:
      - qbtc_network
    environment:
      - AICS_SERVICE_URL=http://aics_service:8001
      - QUANTUM_CORE_SERVICE_URL=http://quantum_core_service:8002
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq/

  aics_service:
    build:
      context: ./services/aics-service
    volumes:
      - ./vigoleonrocks_validation.json:/app/vigoleonrocks_validation.json
    ports:
      - "8001:8001"
    networks:
      - qbtc_network

  quantum_core_service:
    build:
      context: ./services/quantum-core-service
    ports:
      - "8002:8002"
    networks:
      - qbtc_network
    volumes:
      - consciousness_sessions_data:/app/consciousness_sessions

  ollama_worker:
    build:
      context: ./services/ollama-worker
    depends_on:
      - rabbitmq
    environment:
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq/
      - OLLAMA_API_URL=http://host.docker.internal:11434 # Asume que Ollama corre en el host
    networks:
      - qbtc_network

  learning_updater:
    build:
      context: ./services/learning-updater
    depends_on:
      - rabbitmq
      - quantum_core_service
    environment:
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq/
      - QUANTUM_CORE_SERVICE_URL=http://quantum_core_service:8002
    networks:
      - qbtc_network

volumes:
  rabbitmq_data:
  consciousness_sessions_data:

networks:
  qbtc_network:
    driver: bridge
