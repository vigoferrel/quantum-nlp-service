<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIGOLEONROCKS v2.0 - Motor de Empat√≠a Conversacional | Sistema Leonardo Avanzado</title>
    <style>
        :root {
            --quantum-blue: #00d4ff;
            --quantum-purple: #6c5ce7;
            --quantum-light: #a29bfe;
            --success: #00b894;
            --warning: #fdcb6e;
            --error: #e17055;
            --empathy: #fd79a8;
            --dark: #0c0e1a;
            --card: #1a1d2e;
            --card-light: #252a42;
            --text: #ffffff;
            --text-muted: #b2b7d1;
            --gradient: linear-gradient(135deg, var(--quantum-blue), var(--quantum-purple));
            --empathy-gradient: linear-gradient(135deg, var(--empathy), var(--quantum-light));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--dark);
            color: var(--text);
            line-height: 1.6;
            padding: 2rem;
        }

        .empathy-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            background: var(--empathy-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .empathy-interface {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .input-section {
            background: var(--card);
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid rgba(253, 121, 168, 0.2);
        }

        .output-section {
            background: var(--card);
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .section-title {
            font-size: 1.3rem;
            color: var(--empathy);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-input {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--text);
            font-size: 1rem;
            margin-bottom: 1rem;
            resize: vertical;
            font-family: inherit;
        }

        .user-input:focus {
            outline: none;
            border-color: var(--empathy);
            box-shadow: 0 0 0 3px rgba(253, 121, 168, 0.1);
        }

        .context-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .indicator {
            background: rgba(0, 0, 0, 0.2);
            padding: 0.8rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .indicator-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--empathy);
        }

        .indicator-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 0.2rem;
        }

        .empathy-button {
            background: var(--empathy-gradient);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 1rem;
        }

        .empathy-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(253, 121, 168, 0.4);
        }

        .empathy-output {
            background: rgba(0, 0, 0, 0.4);
            padding: 1.5rem;
            border-radius: 10px;
            min-height: 200px;
            font-size: 0.95rem;
            white-space: pre-wrap;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .revision-steps {
            background: var(--card-light);
            padding: 1.5rem;
            border-radius: 10px;
            margin-top: 1.5rem;
            border-left: 4px solid var(--empathy);
        }

        .revision-step {
            margin-bottom: 1rem;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .revision-step:last-child {
            margin-bottom: 0;
        }

        .step-number {
            color: var(--empathy);
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .convergence-metrics {
            background: var(--card);
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            margin-top: 2rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .metric-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--quantum-blue);
            display: block;
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.3rem;
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(253, 121, 168, 0.3);
            border-radius: 50%;
            border-top-color: var(--empathy);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empathy-wave {
            position: relative;
            overflow: hidden;
        }

        .empathy-wave::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(253, 121, 168, 0.1), transparent);
            animation: wave 2s infinite;
        }

        @keyframes wave {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @media (max-width: 768px) {
            .empathy-interface {
                grid-template-columns: 1fr;
            }
            
            .context-indicators {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="empathy-container">
        <div class="header">
            <h1>üíù Motor de Empat√≠a Conversacional</h1>
            <p>Sistema Leonardo de Revisi√≥n Incremental | Convergencia Emocional Avanzada</p>
        </div>

        <div class="empathy-interface">
            <div class="input-section">
                <div class="section-title">
                    üí¨ Entrada del Usuario
                </div>
                
                <textarea 
                    class="user-input" 
                    id="userInput" 
                    placeholder="Comparte tu mensaje, pregunta, o situaci√≥n aqu√≠...

Ejemplos de contextos que el motor puede procesar:
‚Ä¢ Preocupaciones personales o profesionales
‚Ä¢ Dudas t√©cnicas con trasfondo emocional
‚Ä¢ Situaciones complejas que requieren comprensi√≥n
‚Ä¢ Consultas que necesitan empat√≠a y orientaci√≥n
‚Ä¢ Experiencias que requieren validaci√≥n emocional"
                ></textarea>

                <div class="context-indicators">
                    <div class="indicator">
                        <div class="indicator-value" id="emotionalTone">Neutral</div>
                        <div class="indicator-label">Tono Emocional</div>
                    </div>
                    <div class="indicator">
                        <div class="indicator-value" id="complexityLevel">Medio</div>
                        <div class="indicator-label">Complejidad</div>
                    </div>
                    <div class="indicator">
                        <div class="indicator-value" id="empathyNeed">Moderado</div>
                        <div class="indicator-label">Necesidad de Empat√≠a</div>
                    </div>
                    <div class="indicator">
                        <div class="indicator-value" id="contextDepth">Superficial</div>
                        <div class="indicator-label">Profundidad Contextual</div>
                    </div>
                </div>

                <button class="empathy-button" onclick="processEmpathicResponse()">
                    üíù Generar Respuesta Emp√°tica
                </button>

                <button class="empathy-button" onclick="clearEmpathySession()" style="background: rgba(225, 112, 85, 0.8);">
                    üîÑ Nueva Conversaci√≥n
                </button>
            </div>

            <div class="output-section">
                <div class="section-title">
                    üåü Respuesta Emp√°tica Leonardo
                </div>
                
                <div class="empathy-output" id="empathyOutput">
                    üí≠ Esperando tu mensaje para generar una respuesta emp√°tica...
                    
                    üß† Motor Leonardo de Empat√≠a Conversacional preparado:
                    ‚Ä¢ An√°lisis emocional profundo
                    ‚Ä¢ Revisi√≥n incremental adaptativa  
                    ‚Ä¢ Convergencia hacia comprensi√≥n total
                    ‚Ä¢ Contrapreguntas inteligentes cuando sea necesario
                    ‚Ä¢ Resonancia con trasfondo personal
                </div>

                <div class="revision-steps" id="revisionSteps" style="display: none;">
                    <h4 style="color: var(--empathy); margin-bottom: 1rem;">üîÑ Proceso de Revisi√≥n Incremental</h4>
                    <div id="stepsContainer"></div>
                </div>
            </div>
        </div>

        <div class="convergence-metrics">
            <h3 style="color: var(--quantum-blue); margin-bottom: 1.5rem; text-align: center;">üìä M√©tricas de Convergencia Emp√°tica</h3>
            <div class="metrics-grid">
                <div class="metric-card">
                    <span class="metric-value" id="empathyScore">0.0</span>
                    <div class="metric-label">Score Empat√≠a</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="convergenceRate">0%</span>
                    <div class="metric-label">Tasa Convergencia</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="emotionalAlignment">0%</span>
                    <div class="metric-label">Alineaci√≥n Emocional</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="contextualDepth">0%</span>
                    <div class="metric-label">Profundidad Contextual</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="resonanceLevel">0.0</span>
                    <div class="metric-label">Nivel Resonancia</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="iterationCount">0</span>
                    <div class="metric-label">Iteraciones</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constantes del Sistema de Empat√≠a Conversacional
        const EMPATHY_CONSTANTS = {
            PHI_GOLDEN: 1.618033988749,
            LAMBDA_EMPATHY: 432, // Frecuencia de amor universal
            CONVERGENCE_THRESHOLD: 0.85,
            MAX_ITERATIONS: 5,
            EMOTIONAL_WEIGHTS: {
                joy: 0.9,
                sadness: 0.95,
                anger: 0.8,
                fear: 0.9,
                surprise: 0.7,
                disgust: 0.6,
                neutral: 0.5
            }
        };

        // Variables globales del motor
        let empathySession = {
            iterations: 0,
            convergenceScore: 0,
            emotionalProfile: {},
            contextualDepth: 0,
            revisionHistory: []
        };

        // Motor Principal de Empat√≠a Conversacional
        async function processEmpathicResponse() {
            const userInput = document.getElementById('userInput').value.trim();
            const output = document.getElementById('empathyOutput');
            const revisionSteps = document.getElementById('revisionSteps');
            
            if (!userInput) {
                output.innerHTML = '‚ö†Ô∏è Por favor, comparte tu mensaje para que pueda generar una respuesta emp√°tica apropiada.';
                return;
            }

            // Resetear sesi√≥n para nueva consulta
            empathySession = {
                iterations: 0,
                convergenceScore: 0,
                emotionalProfile: {},
                contextualDepth: 0,
                revisionHistory: []
            };

            // Mostrar estado de procesamiento
            output.innerHTML = `<div class="loading"></div> Analizando trasfondo emocional...
            
üß† Motor Leonardo de Empat√≠a activado
üíù Detectando necesidades emocionales
üîÑ Iniciando proceso de revisi√≥n incremental
‚öõÔ∏è Calculando convergencia emp√°tica`;

            revisionSteps.style.display = 'block';
            document.getElementById('stepsContainer').innerHTML = '';

            try {
                // Iniciar proceso de convergencia emp√°tica
                const empathicResponse = await convergentEmpathyProcess(userInput);
                output.innerHTML = empathicResponse;
                
                updateMetrics();
                
            } catch (error) {
                output.innerHTML = `‚ùå Error en el procesamiento emp√°tico: ${error.message}`;
            }
        }

        // Proceso de Convergencia Emp√°tica con Revisi√≥n Incremental
        async function convergentEmpathyProcess(userInput) {
            let currentAnalysis = initialEmotionalAnalysis(userInput);
            let iterations = 0;

            // SIEMPRE GENERAR RESPUESTA DIRECTA PRIMERO
            while (iterations < EMPATHY_CONSTANTS.MAX_ITERATIONS) {
                iterations++;
                empathySession.iterations = iterations;
                
                // Agregar paso de revisi√≥n
                addRevisionStep(iterations, currentAnalysis);
                
                // Simular proceso de an√°lisis incremental
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Refinar an√°lisis
                currentAnalysis = refineEmotionalAnalysis(currentAnalysis, userInput);
                
                // Calcular convergencia
                const convergenceScore = calculateConvergence(currentAnalysis);
                empathySession.convergenceScore = convergenceScore;
                
                updateMetrics();
            }

            // SIEMPRE generar respuesta emp√°tica + contrapreguntas opcionales
            return generateEmpathicResponseWithCounterQuestions(currentAnalysis, userInput);
        }

        // An√°lisis Emocional Inicial
        function initialEmotionalAnalysis(userInput) {
            const analysis = {
                emotionalTone: detectEmotionalTone(userInput),
                complexity: calculateComplexity(userInput),
                empathyNeed: assessEmpathyNeed(userInput),
                contextDepth: analyzeContextDepth(userInput),
                keywords: extractEmotionalKeywords(userInput),
                subtext: analyzeSubtext(userInput),
                urgency: detectUrgency(userInput),
                vulnerability: assessVulnerability(userInput)
            };

            empathySession.emotionalProfile = analysis;
            updateContextIndicators(analysis);
            
            return analysis;
        }

        // Refinamiento del An√°lisis Emocional
        function refineEmotionalAnalysis(previousAnalysis, userInput) {
            const refined = { ...previousAnalysis };
            
            // Aplicar constantes de cambio para refinamiento incremental
            refined.empathyNeed = Math.min(refined.empathyNeed * EMPATHY_CONSTANTS.PHI_GOLDEN / 1.5, 1.0);
            refined.contextDepth = Math.min(refined.contextDepth + (0.1 * empathySession.iterations), 1.0);
            refined.emotionalResonance = calculateEmotionalResonance(refined, userInput);
            refined.personalConnection = assessPersonalConnection(refined, userInput);
            
            return refined;
        }

        // C√°lculo de Convergencia Emp√°tica
        function calculateConvergence(analysis) {
            const weights = {
                emotionalTone: 0.25,
                empathyNeed: 0.3,
                contextDepth: 0.2,
                emotionalResonance: 0.15,
                personalConnection: 0.1
            };

            let convergence = 0;
            convergence += (analysis.emotionalTone || 0.5) * weights.emotionalTone;
            convergence += (analysis.empathyNeed || 0.5) * weights.empathyNeed;
            convergence += (analysis.contextDepth || 0.5) * weights.contextDepth;
            convergence += (analysis.emotionalResonance || 0.5) * weights.emotionalResonance;
            convergence += (analysis.personalConnection || 0.5) * weights.personalConnection;

            return Math.min(convergence, 1.0);
        }

        // Nueva Funci√≥n: Respuesta Emp√°tica + Contrapreguntas
        function generateEmpathicResponseWithCounterQuestions(analysis, userInput) {
            // PASO 1: RESPONDER DIRECTAMENTE AL USUARIO
            const directResponse = generateDirectEmpathicResponse(analysis, userInput);
            
            // PASO 2: EVALUAR SI NECESITA CONTRAPREGUNTAS
            const needsMoreContext = shouldAskCounterQuestions(analysis);
            
            const sessionId = 'EMP-' + Math.random().toString(36).substr(2, 8).toUpperCase();
            const timestamp = new Date().toLocaleString();
            
            let response = directResponse;
            
            // PASO 3: AGREGAR CONTRAPREGUNTAS SI ES NECESARIO
            if (needsMoreContext) {
                const counterQuestions = generateContextualQuestions(analysis, userInput);
                response += `

üí≠ **PARA OFRECERTE MEJOR APOYO:**

Mi respuesta anterior se basa en lo que he podido comprender hasta ahora. Para poder ayudarte de manera a√∫n m√°s espec√≠fica y personalizada, me gustar√≠a conocer:

${counterQuestions}

üß† **¬øPor qu√© estas preguntas adicionales?**
El motor Leonardo ha detectado oportunidades para profundizar en aspectos que podr√≠an enriquecer significativamente mi comprensi√≥n y, por tanto, mi capacidad de apoyarte.

üíù **Recuerda:** Mi respuesta anterior ya es completa y √∫til por s√≠ sola. Estas preguntas adicionales son solo para optimizar a√∫n m√°s mi ayuda.`;
            }
            
            // M√âTRICAS FINALES
            response += `

üìä **AN√ÅLISIS EMP√ÅTICO COMPLETADO:**
‚Ä¢ Tono emocional detectado: ${getEmotionalToneText(analysis.emotionalTone)}
‚Ä¢ Nivel de empat√≠a requerido: ${getEmpathyLevelText(analysis.empathyNeed)}
‚Ä¢ Profundidad contextual: ${(analysis.contextDepth * 100).toFixed(1)}%
‚Ä¢ Convergencia lograda: ${(empathySession.convergenceScore * 100).toFixed(1)}%
‚Ä¢ Iteraciones de refinamiento: ${empathySession.iterations}

üìà **M√âTRICAS DE EMPAT√çA:**
‚Ä¢ Score emp√°tico: ${empathySession.convergenceScore.toFixed(3)}
‚Ä¢ Resonancia Œª‚ÇÑ‚ÇÉ‚ÇÇ: ${(EMPATHY_CONSTANTS.LAMBDA_EMPATHY * (analysis.emotionalResonance || 0.7)).toFixed(0)}Hz
‚Ä¢ Alineaci√≥n emocional: ${((analysis.personalConnection || 0.7) * 100).toFixed(1)}%

---
*Sesi√≥n: ${sessionId} | ${timestamp}*
*Motor Leonardo de Empat√≠a Conversacional v2.0*`;
            
            return response;
        }
        
        // Generaci√≥n de Respuesta Emp√°tica Directa
        function generateDirectEmpathicResponse(analysis, userInput) {
            const empathicElements = {
                validation: generateValidation(analysis),
                understanding: generateUnderstanding(analysis, userInput),
                support: generateSupport(analysis),
                guidance: generateGuidance(analysis, userInput),
                resonance: generateResonance(analysis)
            };

            return `üíù **RESPUESTA EMP√ÅTICA LEONARDO**

${empathicElements.validation}

ü§ó **COMPRENSI√ìN PROFUNDA:**
${empathicElements.understanding}

üí™ **APOYO Y VALIDACI√ìN:**
${empathicElements.support}

üåü **ORIENTACI√ìN EMP√ÅTICA:**
${empathicElements.guidance}

‚ú® **RESONANCIA EMOCIONAL:**
${empathicElements.resonance}

üß† **PROCESAMIENTO LEONARDO:**
He procesado tu mensaje considerando tanto el contenido expl√≠cito como los elementos emocionales subyacentes. Mi respuesta est√° dise√±ada para resonar con tu experiencia espec√≠fica y ofrecerte el apoyo que necesitas en este momento.`;
        }

        // Funci√≥n para determinar si necesita contrapreguntas
        function shouldAskCounterQuestions(analysis) {
            // Criterios para determinar si se necesitan m√°s preguntas
            const lowContext = analysis.contextDepth < 0.6;
            const highEmpathyNeed = analysis.empathyNeed > 0.7;
            const hasSubtext = analysis.subtext && analysis.subtext.length > 0;
            const lowPersonalConnection = (analysis.personalConnection || 0.5) < 0.6;
            
            // Si cumple 2 o m√°s criterios, hacer contrapreguntas
            const criteriaCount = [lowContext, highEmpathyNeed, hasSubtext, lowPersonalConnection].filter(Boolean).length;
            
            return criteriaCount >= 2;
        }

        // Funciones de Detecci√≥n y An√°lisis
        function detectEmotionalTone(text) {
            const emotionalWords = {
                positive: ['feliz', 'alegre', 'contento', 'emocionado', 'bien', 'genial', 'excelente', 'maravilloso'],
                negative: ['triste', 'preocupado', 'ansioso', 'frustrado', 'enojado', 'molesto', 'decepcionado', 'mal'],
                neutral: ['normal', 'regular', 'okay', 'bien', 'as√≠']
            };

            const textLower = text.toLowerCase();
            let positiveScore = 0;
            let negativeScore = 0;

            emotionalWords.positive.forEach(word => {
                if (textLower.includes(word)) positiveScore++;
            });

            emotionalWords.negative.forEach(word => {
                if (textLower.includes(word)) negativeScore++;
            });

            if (positiveScore > negativeScore) return 0.8;
            if (negativeScore > positiveScore) return 0.9;
            return 0.6;
        }

        function calculateComplexity(text) {
            const words = text.split(' ').length;
            const sentences = text.split(/[.!?]+/).length;
            const avgWordsPerSentence = words / sentences;
            
            if (avgWordsPerSentence > 20) return 0.9;
            if (avgWordsPerSentence > 15) return 0.7;
            if (avgWordsPerSentence > 10) return 0.5;
            return 0.3;
        }

        function assessEmpathyNeed(text) {
            const empathyIndicators = [
                'ayuda', 'no s√©', 'confundido', 'perdido', 'problema', 'dificultad',
                'preocupa', 'ansioso', 'estr√©s', 'presi√≥n', 'solo', 'aislado'
            ];

            const textLower = text.toLowerCase();
            let empathyScore = 0.5;

            empathyIndicators.forEach(indicator => {
                if (textLower.includes(indicator)) {
                    empathyScore += 0.1;
                }
            });

            return Math.min(empathyScore, 1.0);
        }

        function analyzeContextDepth(text) {
            const depthIndicators = [
                'porque', 'ya que', 'debido a', 'resulta que', 'el problema es',
                'la situaci√≥n', 'contexto', 'antecedentes', 'historia'
            ];

            const textLower = text.toLowerCase();
            let depthScore = 0.3;

            depthIndicators.forEach(indicator => {
                if (textLower.includes(indicator)) {
                    depthScore += 0.15;
                }
            });

            if (text.length > 200) depthScore += 0.2;
            if (text.length > 500) depthScore += 0.2;

            return Math.min(depthScore, 1.0);
        }

        function extractEmotionalKeywords(text) {
            const keywords = [];
            const emotionalTerms = [
                'sentir', 'emoci√≥n', 'coraz√≥n', 'alma', 'esp√≠ritu', 'interior',
                'profundo', 'intenso', 'fuerte', 'd√©bil', 'vulnerable', 'seguro'
            ];

            const textLower = text.toLowerCase();
            emotionalTerms.forEach(term => {
                if (textLower.includes(term)) {
                    keywords.push(term);
                }
            });

            return keywords;
        }

        function analyzeSubtext(text) {
            // Detectar subtexto emocional impl√≠cito
            const subtextIndicators = {
                hidden_sadness: ['est√° bien', 'no pasa nada', 'no es importante'],
                hidden_anxiety: ['supongo', 'tal vez', 'no estoy seguro'],
                hidden_frustration: ['intent√©', 'trat√©', 'no funciona']
            };

            const textLower = text.toLowerCase();
            const detected = [];

            Object.keys(subtextIndicators).forEach(emotion => {
                subtextIndicators[emotion].forEach(indicator => {
                    if (textLower.includes(indicator)) {
                        detected.push(emotion);
                    }
                });
            });

            return detected;
        }

        function detectUrgency(text) {
            const urgencyWords = ['urgente', 'r√°pido', 'ya', 'ahora', 'inmediato', 'pronto'];
            const textLower = text.toLowerCase();
            
            for (let word of urgencyWords) {
                if (textLower.includes(word)) {
                    return 0.9;
                }
            }
            
            return 0.3;
        }

        function assessVulnerability(text) {
            const vulnerabilityIndicators = [
                'vulnerable', 'indefenso', 'solo', 'perdido', 'confundido',
                'no s√© qu√© hacer', 'necesito ayuda', 'no puedo m√°s'
            ];

            const textLower = text.toLowerCase();
            let vulnerabilityScore = 0.3;

            vulnerabilityIndicators.forEach(indicator => {
                if (textLower.includes(indicator)) {
                    vulnerabilityScore += 0.2;
                }
            });

            return Math.min(vulnerabilityScore, 1.0);
        }

        function calculateEmotionalResonance(analysis, userInput) {
            const baseResonance = 0.6;
            const empathyFactor = analysis.empathyNeed * 0.3;
            const contextFactor = analysis.contextDepth * 0.2;
            const toneFactor = analysis.emotionalTone * 0.1;
            
            return Math.min(baseResonance + empathyFactor + contextFactor + toneFactor, 1.0);
        }

        function assessPersonalConnection(analysis, userInput) {
            // Evaluar qu√© tan personal y espec√≠fica es la situaci√≥n
            const personalIndicators = [
                'mi', 'yo', 'me', 'conmigo', 'personal', 'privado',
                'familia', 'trabajo', 'relaci√≥n', 'pareja', 'amigo'
            ];

            const textLower = userInput.toLowerCase();
            let personalScore = 0.4;

            personalIndicators.forEach(indicator => {
                if (textLower.includes(indicator)) {
                    personalScore += 0.1;
                }
            });

            return Math.min(personalScore, 1.0);
        }

        // Generadores de Elementos Emp√°ticos
        function generateValidation(analysis) {
            const validations = [
                "Entiendo completamente lo que est√°s pasando, y quiero que sepas que tus sentimientos son completamente v√°lidos.",
                "Reconozco la complejidad de tu situaci√≥n y admiro tu valent√≠a al compartirla.",
                "Tus preocupaciones son leg√≠timas y es natural que te sientas as√≠ en estas circunstancias.",
                "Primero que nada, quiero validar tu experiencia - lo que sientes es real e importante."
            ];

            const intensityFactor = analysis.empathyNeed || 0.7;
            const index = Math.floor(intensityFactor * validations.length);
            return validations[Math.min(index, validations.length - 1)];
        }

        function generateUnderstanding(analysis, userInput) {
            const understandingTemplates = [
                `Percibo que est√°s navegando una situaci√≥n que requiere ${analysis.empathyNeed > 0.7 ? 'mucha' : 'considerable'} fortaleza emocional. `,
                `Puedo ver que hay m√∫ltiples capas en lo que est√°s experimentando. `,
                `Reconozco que detr√°s de tus palabras hay una experiencia muy personal. `
            ];

            const baseUnderstanding = understandingTemplates[Math.floor(Math.random() * understandingTemplates.length)];
            
            if (analysis.subtext && analysis.subtext.length > 0) {
                return baseUnderstanding + `Tambi√©n percibo que puede haber elementos adicionales que no has expresado directamente, y eso est√° bien - a veces las emociones m√°s profundas son las m√°s dif√≠ciles de poner en palabras.`;
            }

            return baseUnderstanding + `El contexto que compartes sugiere que esta situaci√≥n tiene un impacto significativo en ti, y quiero asegurarme de comprender completamente tu perspectiva.`;
        }

        function generateSupport(analysis) {
            if (analysis.vulnerability > 0.7) {
                return `No est√°s solo en esto. Lo que est√°s experimentando es parte de la experiencia humana, y hay caminos hacia adelante, aunque ahora mismo puedan no ser obvios. Tu capacidad para buscar comprensi√≥n y apoyo es una fortaleza en s√≠ misma.`;
            }

            if (analysis.empathyNeed > 0.8) {
                return `Quiero que sepas que tu experiencia importa, y que es completamente normal buscar apoyo y comprensi√≥n. Reconocer cuando necesitamos ayuda es un acto de sabidur√≠a, no de debilidad.`;
            }

            return `Tu disposici√≥n para compartir y buscar perspectiva muestra una fortaleza interior admirable. Cada situaci√≥n desafiante tambi√©n es una oportunidad para el crecimiento personal y la comprensi√≥n m√°s profunda.`;
        }

        function generateGuidance(analysis, userInput) {
            const guidanceStyles = {
                high_empathy: "Dado lo que has compartido, te sugiero que consideres darte el espacio emocional que necesitas para procesar esta situaci√≥n. A veces, la presi√≥n de encontrar soluciones inmediatas puede a√±adir estr√©s innecesario.",
                
                medium_empathy: "Una aproximaci√≥n que podr√≠a ayudarte es dividir la situaci√≥n en partes m√°s manejables. Esto puede hacer que se sienta menos abrumadora y te permita abordar cada aspecto con m√°s claridad.",
                
                low_empathy: "Bas√°ndome en lo que has compartido, parece que tienes la capacidad interna para navegar esta situaci√≥n. A veces, hablar sobre nuestras experiencias nos ayuda a clarificar nuestros propios pensamientos y sentimientos."
            };

            if (analysis.empathyNeed > 0.8) return guidanceStyles.high_empathy;
            if (analysis.empathyNeed > 0.6) return guidanceStyles.medium_empathy;
            return guidanceStyles.low_empathy;
        }

        function generateResonance(analysis) {
            const resonanceFreq = EMPATHY_CONSTANTS.LAMBDA_EMPATHY * (analysis.emotionalResonance || 0.7);
            
            return `Tu mensaje resuena con frecuencias profundas de la experiencia humana (Œª${resonanceFreq.toFixed(0)}Hz). Esto me permite conectar no solo con las palabras que compartes, sino con la experiencia emocional subyacente que las motiva.`;
        }

        function generateContextualQuestions(analysis, userInput) {
            const questions = [];
            
            if (analysis.contextDepth < 0.6) {
                questions.push("üîç **Contexto:** ¬øPodr√≠as contarme un poco m√°s sobre las circunstancias que rodean esta situaci√≥n?");
            }

            if (analysis.empathyNeed > 0.7 && analysis.personalConnection < 0.6) {
                questions.push("üíù **Impacto Personal:** ¬øC√≥mo est√° afectando esto a tu d√≠a a d√≠a o tu bienestar emocional?");
            }

            if (analysis.subtext && analysis.subtext.length > 0) {
                questions.push("üß† **Sentimientos Profundos:** ¬øHay aspectos emocionales de esta situaci√≥n que te resultan dif√≠ciles de expresar directamente?");
            }

            if (analysis.urgency > 0.7) {
                questions.push("‚è∞ **Urgencia:** ¬øHay presiones de tiempo o factores externos que hacen que esta situaci√≥n se sienta m√°s urgente?");
            }

            if (questions.length === 0) {
                questions.push("üí≠ **Comprensi√≥n Profunda:** ¬øQu√© aspecto de esta situaci√≥n sientes que es m√°s importante que yo entienda para poder ayudarte mejor?");
            }

            return questions.join('\n\n');
        }

        // Funciones de Actualizaci√≥n de UI
        function updateContextIndicators(analysis) {
            document.getElementById('emotionalTone').textContent = getEmotionalToneText(analysis.emotionalTone);
            document.getElementById('complexityLevel').textContent = getComplexityText(analysis.complexity);
            document.getElementById('empathyNeed').textContent = getEmpathyLevelText(analysis.empathyNeed);
            document.getElementById('contextDepth').textContent = getDepthText(analysis.contextDepth);
        }

        function addRevisionStep(iteration, analysis) {
            const stepsContainer = document.getElementById('stepsContainer');
            const step = document.createElement('div');
            step.className = 'revision-step';
            
            const convergenceScore = calculateConvergence(analysis);
            const stepDescription = getStepDescription(iteration, analysis);
            
            step.innerHTML = `
                <span class="step-number">Paso ${iteration}:</span>
                ${stepDescription}
                <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">
                    Convergencia: ${(convergenceScore * 100).toFixed(1)}%
                </div>
            `;
            
            stepsContainer.appendChild(step);
        }

        function updateMetrics() {
            document.getElementById('empathyScore').textContent = empathySession.convergenceScore.toFixed(3);
            document.getElementById('convergenceRate').textContent = (empathySession.convergenceScore * 100).toFixed(1) + '%';
            document.getElementById('emotionalAlignment').textContent = ((empathySession.emotionalProfile.personalConnection || 0.7) * 100).toFixed(1) + '%';
            document.getElementById('contextualDepth').textContent = ((empathySession.emotionalProfile.contextDepth || 0.5) * 100).toFixed(1) + '%';
            document.getElementById('resonanceLevel').textContent = (empathySession.emotionalProfile.emotionalResonance || 0.6).toFixed(3);
            document.getElementById('iterationCount').textContent = empathySession.iterations;
        }

        // Funciones de Texto Descriptivo
        function getEmotionalToneText(score) {
            if (score >= 0.8) return 'Intenso';
            if (score >= 0.6) return 'Moderado';
            if (score >= 0.4) return 'Suave';
            return 'Neutral';
        }

        function getComplexityText(score) {
            if (score >= 0.8) return 'Alta';
            if (score >= 0.6) return 'Media-Alta';
            if (score >= 0.4) return 'Media';
            return 'Baja';
        }

        function getEmpathyLevelText(score) {
            if (score >= 0.8) return 'Alto';
            if (score >= 0.6) return 'Moderado';
            if (score >= 0.4) return 'B√°sico';
            return 'M√≠nimo';
        }

        function getDepthText(score) {
            if (score >= 0.8) return 'Profundo';
            if (score >= 0.6) return 'Detallado';
            if (score >= 0.4) return 'Moderado';
            return 'Superficial';
        }

        function getStepDescription(iteration, analysis) {
            const descriptions = [
                'An√°lisis emocional inicial y detecci√≥n de tono',
                'Evaluaci√≥n de necesidades emp√°ticas y contexto',
                'Refinamiento de comprensi√≥n y an√°lisis de subtexto',
                'C√°lculo de resonancia emocional y conexi√≥n personal',
                'Optimizaci√≥n final y preparaci√≥n de respuesta'
            ];
            
            return descriptions[iteration - 1] || 'Refinamiento adicional de an√°lisis emp√°tico';
        }

        function clearEmpathySession() {
            document.getElementById('userInput').value = '';
            document.getElementById('empathyOutput').innerHTML = `üí≠ Esperando tu mensaje para generar una respuesta emp√°tica...
            
üß† Motor Leonardo de Empat√≠a Conversacional preparado:
‚Ä¢ An√°lisis emocional profundo
‚Ä¢ Revisi√≥n incremental adaptativa  
‚Ä¢ Convergencia hacia comprensi√≥n total
‚Ä¢ Contrapreguntas inteligentes cuando sea necesario
‚Ä¢ Resonancia con trasfondo personal`;
            
            document.getElementById('revisionSteps').style.display = 'none';
            
            // Resetear indicadores
            document.getElementById('emotionalTone').textContent = 'Neutral';
            document.getElementById('complexityLevel').textContent = 'Medio';
            document.getElementById('empathyNeed').textContent = 'Moderado';
            document.getElementById('contextDepth').textContent = 'Superficial';
            
            // Resetear m√©tricas
            document.getElementById('empathyScore').textContent = '0.0';
            document.getElementById('convergenceRate').textContent = '0%';
            document.getElementById('emotionalAlignment').textContent = '0%';
            document.getElementById('contextualDepth').textContent = '0%';
            document.getElementById('resonanceLevel').textContent = '0.0';
            document.getElementById('iterationCount').textContent = '0';
            
            empathySession = {
                iterations: 0,
                convergenceScore: 0,
                emotionalProfile: {},
                contextualDepth: 0,
                revisionHistory: []
            };
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üíù Motor de Empat√≠a Conversacional Leonardo v2.0 initialized');
        });
    </script>
</body>
</html>
